# Синтаксис

## Секция (Cцена)
Определяется строкой следующего формата:
```
# Имя_сцены | Тип_сцены (Портрет)
```
, где:
- начало секции сцены определяется строкой, которая начинается с символа `#` и пробела;
- `Имя_сцены` - уникальное имя сцены, без пробелов;
- `Тип_сцены` - идентификатор типа сцены. См. XX;
- `(Портрет)` - портрет для типа сцены "диалог".

## Секция (Действие)
Определяется строкой следующего формата:
```
@ Заголовок действия | Тип_сцены (Портрет) | Тэг
```
, где:
- начало секции действия определяется строкой, которая начинается с символа `@` и пробела;
- `Заголовок действия` - текст действия, отображаемый при выборе;
- `Тип_сцены` - идентификатор типа сцены. См. XX;
- `(Портрет)` - портрет для типа сцены "диалог".
- `Тэг` - условное имя действия, без пробелов. Должен быть уникальным среди действий одной сцены.

## Параметр секции (однострочный)
И сцена, и действие могут иметь дополнительные параметры. 
*Однострочный* параметр:
```
*имя_параметра: значение_параметра
```
, где:
- `*` - начало однострочного параметра;
- `имя_параметра` - имя параметра (из фиксированного набора, для разных типов секций параметры могут отличаться); если имя параметра не распознано - строка считается текстом описания;
- `значение_параметра` - значение.

### Тип значения однострочного параметра
Текст:
```
*param: Text           ==> "Text"
```
Переменная JavaScript:
```
*param: `Foo.Bar`      ==> Foo.Bar   
```

Функция JavaScript:
```
*param: { value }*     ==> ()=>{ value }
```

## Параметр секции (многострочный)
Для определения функции в качестве значения бывает удобнее воспользоваться многострочным параметром.

*Многострочный* параметр:
```
**имя_параметра: 
	значение_параметра
	...
*
```
, где:
- `**` - определяет начало многострочного параметра;
- `имя_параметра` - имя параметра, аналогично однострочному параметру;
- `значение_параметра` - значение;
- `*` - определяет конец многострочного параметра; можно не указывать, если за многострочным параметром следует однострочный или конец файла:
```
**param1:
	param_value
	...
*param2: param_value2
```
### Тип значения однострочного параметра
Многострочный параметр всегда трактуется как функция JavaScript:
```
**param1:                 ()=>{
	value_line1;   ==>        value_line1;
	value_line2;              value_line2;
*                          }
```
## Комментарий

Комментарий будет проигнорирован и не попадет в финальный документ.
```
// комментарий
```
## Текст описания
Прочие строки являются строками текстового описания сцены. 

Строки могут содержать HTML разметку (например, `<i>italic</i>` или `<img src='my-pic.png' />`).

Строки могут содержать определение строковой интерполяции JavaScript (код внутри фигурных скобок будет выполнен и результат будет подставлен в то же место):
`Описание сцены с динамическим контентом ${Foo.Bar()}`

Строки описания группируются в блоки, которые будут выводиться вместе, соединенные HTML тегом `<br>` (перенос строки). Пустая строка определяет конец текстового блока.
```
Текст описания, блок1, строка 1.
Текст описания, блок1, строка 2.

Текст описания, блок2, строка 1.
```
Для отдельных блоков можно указывать свой стиль:
```
Короткий_тип| Текст описания в своем стиле.

<| Левый блок.
T| Заголовок
HID| Этого вообще не будет видно
```
, где 
`Короткий_тип` - см. Короткое имя в [[#Тип сцены]].

Для блоков в стиле `dialog_left`/`dialog_right` формат несколько отличается:
```
Короткий_тип|Портрет| Текст описания.

<#|portrait.png| - Это левое диалоговое сообщение.
#>|${Game.Pictures.Char.Hero}| - Это правое диалоговое сообщение.
```
, где
`Короткий_тип` - один из `<#`, `#>`;
`Портрет` - строка с путем до изображения портрета; для динамического указания портрета воспользуйтесь интерполяцией строк JavaScript.

* * *
# Секция

Разметка определяет 2 типа секций: [[#Сцена]] и [[#Действие]].

Все строки в файле следующие за определением секции будут относиться к этой же секции до тех пор, пока не будет определена новая секция.

## Сцена
### Параметры заголовка
#### Тип сцены
Определяет стиль текстовых блоков сцены.
Опциональный, по умолчанию - `scene_center`.

**Тип данных:**
Значение из списка:

Полное имя | Короткое имя | Описание
--- | --- | ---
`scene_center` | `^` | Блок на всю ширину.
`scene_left` | `<` | Блок смещенный влево.
`scene_right` | `>` | Блок смещенный вправо.
`title` | `T` | Заголовок.
`subtitle` | `ST` | Подзаголовок.
`container` | `C` | Контейнер.
`dialog_left` | `<#` | Диалог (текст и картинка-портрет), смещенный влево.
`dialog_right` | `#>` | Диалог (текст и картинка-портрет), смещенный вправо.
`hidden` | `HID` | Скрытый блок (текст не отображается на странице).

Допускается использование как полного, так и короткого имени.

#### Портрет
Задает изображение для портрета. Обязателен при типе сцены `dialog_left` или `dialog_right`, для других типов не делает ничего.

**Тип данных:**
- текст с путем до изображения - `/path/to/img.png`
- строка Base64 с изображением (https://www.base64-image.de/) -   `data:image/png;base64, ...`
- переменная, хранящая путь до изображения или Base64 строку - `` `Game.Pictures.Pic1` ``
- функция, возвращающая путь до изображения или Base64 строку - `{return 'pic.png'}`

### Параметры тела
##### pre_exec
Функция исполняющаяся до вывода описания сцены.
Позволяет динамически менять саму сцену перед ее показом.
Опциональный.

Если функция возвращает `false`, то рендеринг сцены будет отменен (не будет показано описание, не будет выведены действия и не будет выполняться автоматический переход к новой сцене).

**Тип данных:**
JavaScript код в виде функции `{...}` или переменной, ссылающейся на функцию `` `varname` ``.

##### post_exec
Код исполняющийся после вывода описания сцены.
Опциональный.

**Тип данных:**
JavaScript код в виде функции `{...}` или переменной, ссылающейся на функцию `` `varname` ``.

##### goto
Имя сцены на которую следует переходить после показа текущей сцены. Либо функция, возвращающая имя целевой сцены.
Опциональный.

**Тип данных:**
- текст с именем целевой сцены - `NextSceneName`
- переменная, хранящая имя целевой сцены - `` `Game.Scenes.Target` ``
- функция, возвращающая имя целевой сцены  - `{return 'NextSceneName'}`


## Действие
### Параметры заголовка
#### Тип сцены
Определяет стиль текстовых блоков сцены.
Опциональный, по умолчанию - `scene_right`.

**Тип данных:**
См. [[#Тип сцены]]

#### Портрет
См. [[#Портрет]]

#### Тег
Задает тег для действия.
По тегу можно в последующем найти действие, например в теле функции `pre_exec` у сцены, для его изменения.

**Тип данных**
Текст

### Параметры тела
##### scene
Имя сцены, к которой относится действие.
Опционально. По умолчанию - имя сцены расположенной перед действием в одном файле; если такой сцены нет и параметр не указан - будет выброшена ошибка парсинга.

**Тип данных:**
Текст.

##### icon
Конфигурация иконки для действия.
Опционально.

**Тип данных:**
Переменная в формате JS объекта.
```
`{ key: value }`
```
Иконка может быть представлена в нескольких вариантах.
1) Картинка
```
`{ img: 'path/to/image.png' }`
`{ img: Game.Pictures.Icons.Icon1 }`
```
2) Текст (или один символ, смотри [[https://www.w3schools.com/charsets/ref_utf_symbols.asp|Таблица символов]])
```
`{ text: '☎' }`
```
Также есть несколько дополнительных параметров для установки стилей и атрибутов: 
- `class` - CSS класс или список классов (разделенные пробелом)
- `style` - CSS стили (разделенные точкой с запятой `;`)
- `attrs` - HTML атрибуты (объект с парами ключ-значение)

##### condition
Функция, возвращающая булево значение доступности действия (`true` - доступно, `false` - не доступно).
Опциональный. По умолчанию - `true`

**Тип данных:**
JavaScript код в виде функции `{...}` или переменной, ссылающейся на функцию `` `varname` ``.

##### exec
Функция исполняющаяся при выборе сцены.
Опциональный.

Если функция возвращает `false`, то не проверяется значение `goto` и ожидается, что переход к новой сцене должен быть произведен иным способом (внутри функции `exec` или по событию связанному с отображенными интерактивными элементами).

**Тип данных:**
JavaScript код в виде функции `{...}` или переменной, ссылающейся на функцию `` `varname` ``.

##### goto
Имя сцены на которую следует переходить после показа текущей сцены. Либо код, который возвращает имя сцены (код выполняется непосредственно перед переходом к новой сцене).

Опциональный. По умолчанию - имя сцены расположенной после действия в одном файле; если такой сцены нет и параметр не указан - действие не будет совершать автоматический переход к новой сцене.

Альтернативно переход к новой сцене может быть вызван в коде `exec`.

**Тип данных:**
- текст с именем целевой сцены - `NextSceneName`
- переменная, хранящая имя целевой сцены - `` `Game.Scenes.Target` ``
- функция, возвращающая имя целевой сцены  - `{return 'NextSceneName'}`













* * *
# Особенности синтаксиса Obsidian
Если в начале документа будет указана инструкция `#obsidian_md`, то допускается применение следующих приемов.

#### Оформление действий как блоков
Действия могут быть оформлены в стиле именованных блоков разметки Obsidian.
```
------ JSPG markdown ------
@ Action name | Type Portrait | Tag
*param: value

---- Obsidian markdown ----
>[!@] Action name | Type Portrait | Tag
>*param: value
```
*Пример:*
>[!@] Action name | Type Portrait | Tag
>*param: value

#### Ссылки на заголовки как параметр goto
Для параметра `*goto` можно указывать внутренние ссылки на заголовки первого уровня (соответствуют сценам) как ссылку на сцену.
```
------ JSPG markdown ------
*goto: SceneName

---- Obsidian markdown ----
*goto: [[#SceneName]]
```
Ссылки на сцену в другом файле:
```
------ JSPG markdown ------
*goto: SceneName

---- Obsidian markdown ----
*goto: [[AnotherFile#SceneName]]
```
*Пример:*
*goto: [[#Ссылки на заголовки как параметр goto]]

#### Удаление стиля курсива у параметров
Так как параметры начинаются на символ `*`, то Obsidian автоматически ставит еще один символ звездочки в конце строки (что соответствует стилю курсива). Поэтому парсер может сам удалить лишнее.
```
------ JSPG markdown ------
*param: value

---- Obsidian markdown ----
*param: value*
```
*Пример:*
*param: value*

#### Удаление стиля кода в линиях с интерполяцией
Для лучшей заметности элементов интерполяции в описаниях допускается оформлять эти блоки с помощью двух символов `` ` ``.
При парсинге символы будут удалены.
```
------ JSPG markdown ------
Линия описания ${1 > 0 ? "с интерполяцией" : "в строке"}.

---- Obsidian markdown ----
Линия описания ${1 > 0 ? "с интерполяцией" : "в строке"}`.
```
*Пример:*
Линия описания `${1 > 0 ? "с интерполяцией" : "в строке"}`.


# Инструкция `$replace`
Указав инструкцию `$replace:Param1:Param2` в начале документа можно выполнить замену подстрок перед началом парсинга содержимого файла.

Инструкция принимает до 2 параметров разделенных символом двоеточия `:`.
Параметры будут тримированы (удалены пробелы до и после).
Можно указывать несколько функций, но они будут выполнены последовательно в один проход.

Параметры:
`Param1` - целевая подстрока для замены.
`Param2` - (опциональный) подстрока для подстановки. Если не указана, то целевая строка будет просто удалена. 

*Пример:*
```
$replace:AAA:BBB
$replace:    SOMETHING   : WITH ANOTHER THING
```





